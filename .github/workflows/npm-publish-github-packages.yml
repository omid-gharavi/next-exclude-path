name: Node.js Package (publish-test)

on:
  release:
    types: [published]
  workflow_dispatch: {}
  push:
    tags:
      - 'v*'        # use `git tag v1.2.3 && git push origin v1.2.3` to test

permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm ci

  publish-gpr:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://npm.pkg.github.com/
      - run: npm ci
      - run: |
          echo "DEBUG: publishing (dry-run)"; npm publish --dry-run
      # when confirmed working, remove --dry-run and use NODE_AUTH_TOKEN
      # env:
      #   NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
